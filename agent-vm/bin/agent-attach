# agent-attach: SSH into a running agent VM and attach to tmux
# Usage: agent-attach <session-id>

SESSIONS_DIR="${AGENT_VM_SESSIONS:-$HOME/.agent-vm/sessions}"

if [ -z "${1:-}" ]; then
  echo "Usage: agent-attach <session-id>"
  echo ""
  echo "Attach to a running agent VM's tmux session."
  echo ""
  echo "Use 'agent-list' to see available sessions."
  exit 1
fi

SESSION_ID="$1"

# Find the session - support partial ID matching
MATCHING_SESSIONS=()
for dir in "$SESSIONS_DIR"/*/; do
  if [ -d "$dir" ]; then
    dirname=$(basename "$dir")
    if [[ "$dirname" == "$SESSION_ID"* ]]; then
      MATCHING_SESSIONS+=("$dirname")
    fi
  fi
done

if [ ${#MATCHING_SESSIONS[@]} -eq 0 ]; then
  echo "Error: No session found matching '$SESSION_ID'"
  echo "Use 'agent-list' to see available sessions."
  exit 1
fi

if [ ${#MATCHING_SESSIONS[@]} -gt 1 ]; then
  echo "Error: Multiple sessions match '$SESSION_ID':"
  for s in "${MATCHING_SESSIONS[@]}"; do
    echo "  $s"
  done
  echo "Please be more specific."
  exit 1
fi

SESSION_ID="${MATCHING_SESSIONS[0]}"
SESSION_DIR="$SESSIONS_DIR/$SESSION_ID"
META_FILE="$SESSION_DIR/meta.json"

if [ ! -f "$META_FILE" ]; then
  echo "Error: Session metadata not found: $META_FILE"
  exit 1
fi

# Read port from metadata
PORT=$(jq -r '.port // 2222' "$META_FILE")
STATUS=$(jq -r '.status // "unknown"' "$META_FILE")

if [ "$STATUS" != "running" ]; then
  echo "Warning: Session status is '$STATUS' (not 'running')"
  echo "The VM may not be available. Try 'agent-resume $SESSION_ID' to restart."
fi

echo "Attaching to session $SESSION_ID on port $PORT..."
echo "Press Ctrl+B, D to detach from tmux (leave agent running)"
echo ""

# SSH into the VM and attach to tmux
ssh -p "$PORT" \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o LogLevel=ERROR \
    agent@localhost \
    -t "tmux attach -t agent 2>/dev/null || tmux new-session -s agent"
