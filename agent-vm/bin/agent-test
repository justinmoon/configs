# agent-test: Automated test for agent-vm functionality
# Tests: spawn, SSH, tmux session, environment, and cleanup

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

FAILED=0

pass() {
  echo -e "${GREEN}✓ $1${NC}"
}

fail() {
  echo -e "${RED}✗ $1${NC}"
  FAILED=1
}

info() {
  echo -e "${YELLOW}→ $1${NC}"
}

cleanup() {
  info "Cleaning up..."
  pkill -f "qemu-system-aarch64.*agent" 2>/dev/null || true
  rm -f /tmp/agent-vm-session
  if [ -n "${SESSION_ID:-}" ] && [ -d "$HOME/.agent-vm/sessions/$SESSION_ID" ]; then
    rm -rf "$HOME/.agent-vm/sessions/$SESSION_ID"
  fi
}

trap cleanup EXIT

# Check prerequisites
info "Checking prerequisites..."

if [ -z "${ANTHROPIC_API_KEY:-}" ]; then
  fail "ANTHROPIC_API_KEY not set"
  exit 1
fi

if ! command -v nix &> /dev/null; then
  fail "nix not found"
  exit 1
fi

pass "Prerequisites OK"

# Test 1: Spawn a VM
info "Test 1: Spawning VM..."

# Use a small test repo
SPAWN_OUTPUT=$(nix run .#agent-spawn -- --repo https://github.com/juspay/nix-dev-home 2>&1) || {
  fail "agent-spawn failed"
  echo "$SPAWN_OUTPUT"
  exit 1
}

# Extract session ID (last line of output)
SESSION_ID=$(echo "$SPAWN_OUTPUT" | tail -1)

if [ -z "$SESSION_ID" ] || [ ${#SESSION_ID} -ne 8 ]; then
  fail "Failed to get session ID"
  echo "$SPAWN_OUTPUT"
  exit 1
fi

pass "VM spawned with session ID: $SESSION_ID"

# Get port from metadata
PORT=$(jq -r '.port' "$HOME/.agent-vm/sessions/$SESSION_ID/meta.json")
if [ -z "$PORT" ] || [ "$PORT" = "null" ]; then
  fail "Failed to get SSH port"
  exit 1
fi

pass "SSH port: $PORT"

# Wait for SSH to be ready
info "Waiting for SSH..."
for i in {1..30}; do
  if nc -z localhost "$PORT" 2>/dev/null; then
    break
  fi
  sleep 1
done

if ! nc -z localhost "$PORT" 2>/dev/null; then
  fail "SSH not ready after 30s"
  exit 1
fi

pass "SSH is ready"

# Wait a bit more for systemd to start the agent service
sleep 10

# Test 2: SSH and check basic connectivity
info "Test 2: SSH connectivity..."

SSH_CMD="sshpass -p agent ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p $PORT agent@localhost"

HOSTNAME=$($SSH_CMD hostname 2>/dev/null) || {
  fail "SSH connection failed"
  exit 1
}

if [ "$HOSTNAME" = "agent" ]; then
  pass "SSH works, hostname: $HOSTNAME"
else
  fail "Unexpected hostname: $HOSTNAME"
fi

# Test 3: Check env file is readable
info "Test 3: Environment file permissions..."

ENV_PERMS=$($SSH_CMD "ls -l /session/env | awk '{print \$1}'" 2>/dev/null) || {
  fail "Failed to check env file"
  exit 1
}

if [[ "$ENV_PERMS" == *"r--r--r--"* ]] || [[ "$ENV_PERMS" == *"rw-r--r--"* ]]; then
  pass "Env file is readable: $ENV_PERMS"
else
  fail "Env file not readable: $ENV_PERMS"
fi

# Test 4: Check API key is present
info "Test 4: API key in environment..."

API_KEY_PRESENT=$($SSH_CMD "cat /session/env | grep -c ANTHROPIC_API_KEY" 2>/dev/null) || true

if [ "$API_KEY_PRESENT" = "1" ]; then
  pass "API key present in env file"
else
  fail "API key not in env file"
fi

# Test 5: Check tmux session
info "Test 5: tmux session..."

TMUX_OUTPUT=$($SSH_CMD "tmux ls 2>&1" 2>/dev/null) || true

if echo "$TMUX_OUTPUT" | grep -q "agent:"; then
  pass "tmux session 'agent' exists"
else
  fail "tmux session not found: $TMUX_OUTPUT"
fi

# Test 6: Check opencode is running
info "Test 6: opencode process..."

OPENCODE_RUNNING=$($SSH_CMD "ps aux | grep -c '[o]pencode'" 2>/dev/null) || true

if [ "$OPENCODE_RUNNING" -ge "1" ]; then
  pass "opencode is running"
else
  fail "opencode not running"
fi

# Test 7: Check environment in tmux
info "Test 7: Environment in tmux session..."

TMUX_ENV=$($SSH_CMD "tmux show-environment -t agent 2>/dev/null | grep ANTHROPIC" 2>/dev/null) || true

if echo "$TMUX_ENV" | grep -q "ANTHROPIC_API_KEY="; then
  pass "ANTHROPIC_API_KEY set in tmux environment"
else
  fail "ANTHROPIC_API_KEY not in tmux environment: $TMUX_ENV"
fi

# Summary
echo ""
echo "================================"
if [ $FAILED -eq 0 ]; then
  echo -e "${GREEN}All tests passed!${NC}"
  exit 0
else
  echo -e "${RED}Some tests failed${NC}"
  exit 1
fi
