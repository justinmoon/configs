#!/bin/bash
# Interactive 1Password CLI secret selector

if ! command -v op &> /dev/null; then
    echo "1Password CLI (op) not installed"
    exit 1
fi

if ! command -v fzf &> /dev/null; then
    echo "fzf not installed. Install with: brew install fzf"
    exit 1
fi

# Get all items in the cli vault
items=$(op item list --vault cli --format json 2>/dev/null)

if [ -z "$items" ] || [ "$items" = "[]" ]; then
    echo "No 'cli' vault found or no items in it"
    echo ""
    echo "To create the vault and add items:"
    echo "  1. Create a 'cli' vault in 1Password"
    echo "  2. Add items like 'openai' with field 'configs' containing your API key"
    echo "  3. Reference as: op://cli/openai/configs"
    exit 1
fi

# Build a list of all available secret paths
secret_paths=""
echo "$items" | jq -r '.[] | .title' | while read -r item; do
    item_details=$(op item get "$item" --vault cli --format json 2>/dev/null)
    
    echo "$item_details" | jq -r '
        .fields[]? | 
        select(.value != null and .value != "") | 
        .label // .id
    ' | while read -r field; do
        if [ -n "$field" ] && [ "$field" != "null" ]; then
            echo "op://cli/$item/$field"
        fi
    done
done | fzf \
    --height 40% \
    --border \
    --prompt "Select secret to copy: " \
    --header "↑/↓ to move, Enter to copy to clipboard, Esc to cancel" | {
    read -r selected
    if [ -n "$selected" ]; then
        # Copy the secret to clipboard
        op read "$selected" | pbcopy
        echo "✓ Copied $selected to clipboard"
    fi
}