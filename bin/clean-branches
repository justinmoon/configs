#!/bin/bash
# Interactively select and delete git branches not tied to worktrees.

echo -e "\nüßπ Clean Branches\n"

# Get all worktree branches to exclude them
worktree_branches=()
while IFS= read -r line; do
    if [[ "$line" == "branch "* ]]; then
        branch="${line#branch refs/heads/}"
        worktree_branches+=("$branch")
    fi
done < <(git worktree list --porcelain)

# Get all local branches
all_branches=$(git branch --format="%(refname:short)")
non_worktree_branches=()

for branch in $all_branches; do
    # Skip master/main
    if [[ "$branch" == "master" ]] || [[ "$branch" == "main" ]]; then
        continue
    fi
    
    # Check if this branch is associated with a worktree
    is_worktree=false
    for wb in "${worktree_branches[@]}"; do
        if [[ "$wb" == "$branch" ]]; then
            is_worktree=true
            break
        fi
    done
    
    if ! $is_worktree; then
        non_worktree_branches+=("$branch")
    fi
done

if [ ${#non_worktree_branches[@]} -eq 0 ]; then
    echo "‚ú® No branches to clean!"
    exit 0
fi

# Check if fzf is available for multi-select
if command -v fzf >/dev/null 2>&1; then
    # Use fzf for multi-select
    echo "Select branches to delete (use Tab to multi-select, Enter to confirm):"
    echo
    
    # Get selections
    selections=$(printf '%s\n' "${non_worktree_branches[@]}" | fzf --multi --height=40% --reverse --header="Use Tab to select, Enter to confirm" --prompt="Delete > ")
    
    if [ -z "$selections" ]; then
        echo "No selections made. Cancelled."
        exit 0
    fi
    
    # Parse selections into array
    to_delete_branches=()
    while IFS= read -r branch; do
        to_delete_branches+=("$branch")
    done <<< "$selections"
else
    # Fallback to simple selection
    echo "üåø Branches (not associated with worktrees):"
    for i in "${!non_worktree_branches[@]}"; do
        echo "  $((i+1)). ${non_worktree_branches[$i]}"
    done
    echo
    echo "Select items to delete:"
    echo "  - Enter numbers separated by spaces (e.g., 1 3 5)"
    echo "  - Enter 'all' to delete all branches"
    echo "  - Press Enter to cancel"
    read -p "> " selection
    
    if [ -z "$selection" ]; then
        echo "Cancelled."
        exit 0
    fi
    
    # Parse selection
    to_delete_branches=()
    
    if [[ "$selection" == "all" ]]; then
        to_delete_branches=("${non_worktree_branches[@]}")
    else
        for num in $selection; do
            if [[ "$num" =~ ^[0-9]+$ ]]; then
                idx=$((num-1))
                if [ $idx -ge 0 ] && [ $idx -lt ${#non_worktree_branches[@]} ]; then
                    to_delete_branches+=("${non_worktree_branches[$idx]}")
                fi
            fi
        done
    fi
fi

# Confirm deletion
if [ ${#to_delete_branches[@]} -eq 0 ]; then
    echo "No valid selections. Cancelled."
    exit 0
fi

echo -e "\n‚ö†Ô∏è  Will delete:"
for branch in "${to_delete_branches[@]}"; do
    echo "  - $branch"
done

read -p $'\nProceed? (y/N): ' confirm
if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
    echo "Cancelled."
    exit 0
fi

echo -e "\nüóëÔ∏è  Deleting..."

# Delete branches
for branch in "${to_delete_branches[@]}"; do
    echo "  Deleting branch: $branch"
    git branch -D "$branch" 2>/dev/null || echo "    ‚ö†Ô∏è  Could not delete branch $branch"
done

echo -e "\n‚úÖ Done!"