#!/usr/bin/env bash
# SSH askpass for FIDO2 PIN - uses pinentry-mac for GUI dialog
# This allows ssh-agent to prompt for YubiKey PIN when running in background

PINENTRY="${PINENTRY:-/opt/homebrew/bin/pinentry-mac}"

# If pinentry-mac isn't available, try pinentry from nix
if [ ! -x "$PINENTRY" ]; then
  PINENTRY="$(command -v pinentry-mac 2>/dev/null || command -v pinentry 2>/dev/null)"
fi

if [ -z "$PINENTRY" ] || [ ! -x "$PINENTRY" ]; then
  echo "Error: pinentry not found" >&2
  exit 1
fi

out="$("$PINENTRY" <<EOF
SETTITLE SSH YubiKey PIN
SETDESC Enter the FIDO2 PIN for your YubiKey
SETPROMPT PIN:
GETPIN
EOF
)"

# Extract the "D <secret>" line from pinentry protocol
pin=$(printf '%s\n' "$out" | awk '/^D /{sub(/^D /,"");print;exit}')
[ -n "$pin" ] || exit 1
printf '%s\n' "$pin"
