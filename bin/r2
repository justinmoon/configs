#!/bin/bash
# R2 upload wrapper using rclone with age-encrypted credentials
#
# Buckets:
#   private - Personal storage, not publicly accessible (default)
#   public  - Publicly accessible files, use for sharing
#
# Usage:
#   r2 copy file.tar.gz r2:private/backups/    # Upload to private bucket
#   r2 copy file.tar.gz r2:public/share/       # Upload to public bucket (prints URL)
#   r2 ls r2:private/
#   r2 sync ./folder r2:private/backup/
#
# Setup:
#   1. Create R2 API tokens at: https://dash.cloudflare.com/ -> R2 -> Manage R2 API Tokens
#   2. Create ~/configs/secrets/r2.age with:
#      R2_ACCESS_KEY_ID=your_access_key
#      R2_SECRET_ACCESS_KEY=your_secret_key
#      R2_ENDPOINT=https://ACCOUNT_ID.r2.cloudflarestorage.com
#      R2_PUBLIC_BUCKET_PUBLIC_URL=https://pub-xxx.r2.dev  # for public bucket URLs
#
# All rclone commands work.

set -euo pipefail

# Show help (no YubiKey needed)
show_help() {
    echo "Usage: r2 <rclone-command> [args...]"
    echo ""
    echo "Buckets:"
    echo "  r2:private/  Personal storage, not publicly accessible (default for most uses)"
    echo "  r2:public/   Publicly accessible, use only for intentional sharing"
    echo ""
    echo "Examples:"
    echo "  r2 copy file.tar.gz r2:private/backups/   # Private upload"
    echo "  r2 copy file.tar.gz r2:public/share/      # Public upload (prints URL)"
    echo "  r2 ls r2:private/"
    echo "  r2 sync ./folder r2:private/backup/"
    exit 0
}

# Handle help flags and no args before touching credentials
if [[ $# -eq 0 || "$1" == "-h" || "$1" == "--help" || "$1" == "help" ]]; then
    show_help
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIGS_DIR="$(dirname "$SCRIPT_DIR")"

if ! command -v rclone &> /dev/null; then
    echo "rclone not installed"
    exit 1
fi

if ! command -v age &> /dev/null; then
    echo "age not installed"
    exit 1
fi

# Extract bucket name from arguments
detect_bucket() {
    for arg in "$@"; do
        if [[ "$arg" == r2:* ]]; then
            local bucket_and_path="${arg#r2:}"
            echo "${bucket_and_path%%/*}"
            return
        fi
    done
    echo ""
}

BUCKET=$(detect_bucket "$@")

# Validate bucket before decrypting
case "$BUCKET" in
    public|private)
        ;;
    "")
        echo "No r2: path specified"
        echo "Run 'r2 --help' for usage"
        exit 1
        ;;
    *)
        echo "Unknown bucket: $BUCKET"
        echo "Available buckets: private, public"
        exit 1
        ;;
esac

# Decrypt and source R2 credentials (requires YubiKey tap)
eval "$(age -d -i "$CONFIGS_DIR/yubikeys/keys.txt" "$CONFIGS_DIR/secrets/r2.age")"

# Set public URL only for public bucket
if [[ "$BUCKET" == "public" ]]; then
    PUBLIC_URL="${R2_PUBLIC_BUCKET_PUBLIC_URL:-}"
else
    PUBLIC_URL=""
fi

# Configure rclone via environment variables (no config file needed)
export RCLONE_CONFIG_R2_TYPE=s3
export RCLONE_CONFIG_R2_PROVIDER=Cloudflare
export RCLONE_CONFIG_R2_ACCESS_KEY_ID="$R2_ACCESS_KEY_ID"
export RCLONE_CONFIG_R2_SECRET_ACCESS_KEY="$R2_SECRET_ACCESS_KEY"
export RCLONE_CONFIG_R2_ENDPOINT="$R2_ENDPOINT"
export RCLONE_CONFIG_R2_ACL=private
export RCLONE_CONFIG_R2_NO_CHECK_BUCKET=true

# For copy/copyto commands, print the public URL on success (public bucket only)
if [[ "$1" == "copy" || "$1" == "copyto" ]]; then
    # Extract destination (last arg starting with r2:)
    dest=""
    src=""
    for arg in "${@:2}"; do
        if [[ "$arg" == r2:* ]]; then
            dest="$arg"
        elif [[ ! "$arg" == -* && -z "$src" ]]; then
            src="$arg"
        fi
    done

    if [[ -n "$dest" && -n "$src" ]]; then
        rclone "$@"
        exit_code=$?
        if [[ $exit_code -eq 0 && -n "$PUBLIC_URL" ]]; then
            # Strip r2: prefix to get bucket/path
            bucket_and_path="${dest#r2:}"
            # Strip bucket name (first component) to get just the path
            path="${bucket_and_path#*/}"
            # For 'copy' command, append the source filename to directory destinations
            if [[ "$1" == "copy" && ("$path" == */ || -z "$path") ]]; then
                path="${path}$(basename "$src")"
            fi
            echo ""
            echo "URL: ${PUBLIC_URL%/}/${path}"
        fi
        exit $exit_code
    fi
fi

exec rclone "$@"
