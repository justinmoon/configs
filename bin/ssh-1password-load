#!/usr/bin/env bash
# Load 1Password SSH key into agent for emergency access
# Use when both YubiKeys are unavailable
set -euo pipefail

PUB_KEY_PATH="$HOME/.ssh/id_ed25519_1password.pub"

echo "Loading 1Password SSH key into agent..."
echo "You will be prompted to authenticate with 1Password."
echo ""

# Ensure ssh-agent is running
if [ -z "${SSH_AUTH_SOCK:-}" ]; then
    echo "Error: SSH agent not running. Start it with: eval \$(ssh-agent)"
    exit 1
fi

# Read key from 1Password and add to agent
# The key will be available until you run ssh-1password-unload or the agent restarts
op read "op://cli/ssh/key" | ssh-add -

# Save the public key for unload script
ssh-keygen -y -f <(op read "op://cli/ssh/key") > "$PUB_KEY_PATH" 2>/dev/null || true

echo ""
echo "1Password SSH key loaded into agent."
echo "Run 'ssh-1password-unload' when done to remove it."
