#!/usr/bin/env bash
# Interactively select and remove git worktrees via fzf.

set -euo pipefail

if ! command -v git >/dev/null 2>&1; then
    echo "git is required" >&2
    exit 1
fi

if ! command -v fzf >/dev/null 2>&1; then
    echo "fzf is required for this command" >&2
    exit 1
fi

if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    echo "Not inside a git repository" >&2
    exit 1
fi

repo_root="$(git rev-parse --show-toplevel)"

get_epoch() {
    local target="$1"
    if [[ -e "$target" ]]; then
        if epoch=$(stat -f "%m" "$target" 2>/dev/null); then
            printf '%s' "$epoch"
            return
        fi
        if epoch=$(stat -c "%Y" "$target" 2>/dev/null); then
            printf '%s' "$epoch"
            return
        fi
    fi
    printf '0'
}

format_human_date() {
    local epoch="$1"
    if [[ "$epoch" == "0" ]]; then
        printf 'unknown'
        return
    fi
    if human=$(date -r "$epoch" "+%Y-%m-%d %H:%M:%S" 2>/dev/null); then
        printf '%s' "$human"
        return
    fi
    if human=$(date -d "@$epoch" "+%Y-%m-%d %H:%M:%S" 2>/dev/null); then
        printf '%s' "$human"
        return
    fi
    printf 'unknown'
}

declare -a worktree_rows=()

# Parse git worktree list porcelain output
current_path=""
current_branch=""
while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ "$line" == worktree\ * ]]; then
        current_path="${line#worktree }"
        current_branch=""
    elif [[ "$line" == branch\ refs/heads/* ]]; then
        current_branch="${line#branch refs/heads/}"
    elif [[ "$line" == branch\ * ]]; then
        current_branch="${line#branch }"
    elif [[ -z "$line" && -n "$current_path" ]]; then
        branch_display="${current_branch:-detached}"
        is_main="false"
        if [[ "$current_path" == "$repo_root" ]]; then
            is_main="true"
            branch_display="${branch_display} [main]"
        fi
        status=""
        if [[ ! -d "$current_path" ]]; then
            status="[missing]"
        fi
        epoch="$(get_epoch "$current_path")"
        human_date="$(format_human_date "$epoch")"
        if [[ -n "$status" ]]; then
            branch_display="${branch_display} ${status}"
        fi
        printf -v row '%s\t%s\t%s\t%s\t%s' \
            "$epoch" \
            "$human_date" \
            "$branch_display" \
            "$current_path" \
            "$is_main"
        worktree_rows+=("$row")
        current_path=""
        current_branch=""
    fi
done < <(git -C "$repo_root" worktree list --porcelain)

if [[ ${#worktree_rows[@]} -eq 0 ]]; then
    echo "No worktrees found"
    exit 0
fi

sorted_rows="$(printf '%s\n' "${worktree_rows[@]}" | sort -rn -t $'\t' -k1,1)"

selection="$(printf '%s\n' "$sorted_rows" | fzf \
    --multi \
    --ansi \
    --bind 'start:select-all' \
    --delimiter=$'\t' \
    --with-nth=2,3,4 \
    --header='Select worktrees to remove (Enter to confirm, Esc to cancel)' \
    --preview='ls -a {4} 2>/dev/null | head -n 50' \
    --preview-window='down,40%,border')"

if [[ -z "$selection" ]]; then
    echo "No worktrees selected"
    exit 0
fi

declare -a to_remove=()
declare -a skipped=()
while IFS= read -r sel_line || [[ -n "$sel_line" ]]; do
    [[ -z "$sel_line" ]] && continue
    path="$(printf '%s' "$sel_line" | cut -f4)"
    is_main="$(printf '%s' "$sel_line" | cut -f5)"
    branch_info="$(printf '%s' "$sel_line" | cut -f3)"
    if [[ "$is_main" == "true" ]]; then
        skipped+=("${path} (main worktree)")
        continue
    fi
    to_remove+=("$path|$branch_info")
done <<< "$selection"

if [[ ${#to_remove[@]} -eq 0 ]]; then
    echo "Nothing to remove."
    if [[ ${#skipped[@]} -gt 0 ]]; then
        printf 'Skipped:\n'
        printf '  %s\n' "${skipped[@]}"
    fi
    exit 0
fi

echo "Will remove ${#to_remove[@]} worktree(s):"
for item in "${to_remove[@]}"; do
    path="${item%%|*}"
    branch="${item#*|}"
    printf '  %s (%s)\n' "$path" "$branch"
done
if [[ ${#skipped[@]} -gt 0 ]]; then
    printf 'Skipped:\n'
    printf '  %s\n' "${skipped[@]}"
fi

read -r -p "Proceed? (y/N): " confirm
if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
    echo "Cancelled."
    exit 0
fi

for item in "${to_remove[@]}"; do
    path="${item%%|*}"
    echo "Removing $path"
    if ! git -C "$repo_root" worktree remove --force "$path"; then
        echo "  Failed to remove $path" >&2
    fi
done

echo "Done."
