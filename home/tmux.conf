# Set prefix
# set -g prefix C-b
# unbind C-b
# unbind C-l # Somehow my prefix was set to this ... no idea how ... this is probably not necessary
# bind C-b send-prefix

# Set prefix to Ctrl+Space
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# Mouse mode?
set -g mouse on

# Reload config
bind-key r source-file ~/.config/tmux/tmux.conf \; display-message "~/.config/tmux/tmux.conf reloaded"

# Re-order windows with wrapping
# Move left: if at first window, move to end; otherwise swap with previous
bind-key -n C-S-Left run-shell 'tmux-move-window-left'
# Move right: if at last window, move to beginning; otherwise swap with next  
bind-key -n C-S-Right run-shell 'tmux-move-window-right'

# Easy window swapping - prefix + s + number
bind-key s command-prompt -p "swap window with:" "swap-window -t %%"
# Move current window to specific position - prefix + m + number  
bind-key m command-prompt -p "move window to position:" "move-window -t %%"

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# vi keys in search
setw -g mode-keys vi

# Enable OSC 52 clipboard integration (works over SSH)
set -s set-clipboard on

# y yanks text in copy mode
bind-key -T copy-mode-vi y send -X copy-selection

# Keep mouse selections from snapping back to the bottom
unbind -T copy-mode-vi MouseDragEnd1Pane
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection
unbind -T copy-mode MouseDragEnd1Pane
bind -T copy-mode MouseDragEnd1Pane send -X copy-selection


# Longer shell history
set-option -g history-limit 100000

# Keep EDITOR/VISUAL synced with the shell that launches tmux
set-option -ga update-environment "EDITOR"
set-option -ga update-environment "VISUAL"

# https://github.com/helix-editor/helix/wiki/Troubleshooting#when-using-tmux-or-screen-there-is-a-delay-after-hitting-escape-before-its-registered
set -sg escape-time 0

# Enable true color support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc,ghostty:Tc"

# Undercurl support (for better syntax highlighting)
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

# sesh+fzf
unbind "i"
bind-key "i" run-shell "sesh connect \"$(
	sesh list | fzf-tmux -p 55%,60% \
		--no-sort --ansi --border-label ' sesh ' --prompt '‚ö°  ' \
		--header '  ^a all ^t tmux ^g configs ^x zoxide ^d tmux kill ^f find' \
		--bind 'tab:down,btab:up' \
		--bind 'ctrl-a:change-prompt(‚ö°  )+reload(sesh list)' \
		--bind 'ctrl-t:change-prompt(ü™ü  )+reload(sesh list -t)' \
		--bind 'ctrl-g:change-prompt(‚öôÔ∏è  )+reload(sesh list -c)' \
		--bind 'ctrl-x:change-prompt(üìÅ  )+reload(sesh list -z)' \
		--bind 'ctrl-f:change-prompt(üîé  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
		--bind 'ctrl-d:execute(tmux kill-session -t {})+change-prompt(‚ö°  )+reload(sesh list)'
)\""

# neovim colorschemes are broken without this
# (commented out b/c doesn't seem necessary anymore)
# set -g default-terminal "screen-256color"

# sesh+gum
bind-key "k" display-popup -E -w 40% "sesh connect \"$(
	sesh list -i | gum filter --limit 1 --placeholder 'Pick a sesh' --height 50 --prompt='‚ö°'
)\""

# checkout switcher (gum)
bind-key "K" display-popup -E -w 60% -h 60% "/Users/justin/configs/bin/checkout-switch-popup"
# new window + checkout picker
bind-key "C" display-popup -E -w 60% -h 60% "/Users/justin/configs/bin/checkout-switch-popup --new-window"

# sesh last
unbind o
unbind u
bind-key "u" run-shell "sesh last"

# Smart window switching - press same number twice to go back
bind-key 1 if-shell 'test #{window_index} -eq 1' 'last-window' 'select-window -t 1'
bind-key 2 if-shell 'test #{window_index} -eq 2' 'last-window' 'select-window -t 2'
bind-key 3 if-shell 'test #{window_index} -eq 3' 'last-window' 'select-window -t 3'
bind-key 4 if-shell 'test #{window_index} -eq 4' 'last-window' 'select-window -t 4'
bind-key 5 if-shell 'test #{window_index} -eq 5' 'last-window' 'select-window -t 5'
bind-key 6 if-shell 'test #{window_index} -eq 6' 'last-window' 'select-window -t 6'
bind-key 7 if-shell 'test #{window_index} -eq 7' 'last-window' 'select-window -t 7'
bind-key 8 if-shell 'test #{window_index} -eq 8' 'last-window' 'select-window -t 8'
bind-key 9 if-shell 'test #{window_index} -eq 9' 'last-window' 'select-window -t 9'

# recommended configurations by sesh
bind-key x kill-pane # skip "kill-pane 1? (y/n)" prompt
set -g detach-on-destroy off  # don't exit from tmux when closing a session

# Set fish as default shell
set -g default-command /etc/profiles/per-user/justin/bin/fish
set -g default-shell /etc/profiles/per-user/justin/bin/fish

# Default theme: nord
set -g status-style "bg=#2e3440,fg=#d8dee9"
set -g message-style "bg=#3b4252,fg=#d8dee9"
set -g message-command-style "bg=#3b4252,fg=#d8dee9"
set -g pane-border-style "fg=#4c566a"
set -g pane-active-border-style "fg=#81a1c1"
set -g display-panes-active-colour "#81a1c1"
set -g display-panes-colour "#4c566a"
set -g clock-mode-colour "#81a1c1"
set -g status-justify centre
set-option -g status-left '#[fg=#2e3440,bg=#81a1c1,bold] #{session_name} '
set-option -g status-left-length 50
set-option -g status-right '#[fg=#d8dee9,bg=#2e3440] %Y-%m-%d %H:%M '
set-option -wg window-status-current-format '#[bg=#81a1c1,fg=#2e3440,bold] #{window_index} #{window_name} #{window_flags} '
# Bell-aware format: yellow highlight when bell is ringing, normal otherwise
set-option -wg window-status-format '#{?window_bell_flag,#[bg=yellow#,fg=black#,bold],#[bg=#3b4252#,fg=#d8dee9]} #{window_index} #{window_name} #{window_flags} '

# Bell/alert highlighting for agent notifications
# When a window rings the bell (e.g., OpenCode notify tool), highlight it
set-option -g visual-bell off
set-option -g bell-action other
set-option -wg monitor-bell on

# Load active theme overrides if present (generated by bin/colorscheme)
if-shell "test -f ~/.local/state/colorscheme/tmux.conf" "source-file ~/.local/state/colorscheme/tmux.conf"

# Window directory configuration
# Makes new panes/splits inherit the current pane's working directory
# When splitting horizontally (creates a vertical split line)
bind '"' split-window -v -c "#{pane_current_path}"
# When splitting vertically (creates a horizontal split line)  
bind % split-window -h -c "#{pane_current_path}"
